let popupList=document.getElementById("list"),salesTable=document.getElementById("salesTable"),todaysEarnings=document.getElementById("todaysEarnings"),todaysCircle=document.getElementById("todaysCircle"),weeklyEarnings=document.getElementById("weeklyEarnings"),weeklyCircle=document.getElementById("weeklyCircle"),monthlyEarnings=document.getElementById("monthlyEarnings"),monthlyCircle=document.getElementById("monthlyCircle"),imageInput=document.getElementById("image"),nameInput=document.getElementById("name"),goal=document.getElementById("goal"),salesSwitch=document.getElementById("onOffSwitch"),username=document.getElementById("username"),input=document.getElementById("login"),loginBtnDiv=document.getElementById("loginBtnDiv"),loginInput=document.getElementById("loginInput");chrome.storage.sync.get(function(e){e.isPremium?(loginInput.innerHTML="<div style='justify-content:center;align-items:center'>Premium User &#x1F389</div>",loginBtnDiv.style.display="none"):(loginBtnDiv.style.display="display-block",loginInput.innerHTML+='<hr style="margin:5px"></hr><div style="justify-content:center;align-items:center">Upgrade to TpT-Informer <a target="_blank" rel="noopener noreferrer" href="https://tpt-informer.web.app/"><u>premium</u></a></div><hr style="margin:5px"></hr>')}),input.addEventListener("click",function(e){fetch("https://tpt-informer-default-rtdb.firebaseio.com/users/"+username.value+".json").then(e=>{if(!e.ok)throw Error("Network response was not ok.");return console.log(e),e.json()}).then(e=>{e==username.value?(chrome.storage.sync.set({isPremium:!0}),loginInput.innerHTML="<div style='justify-content:center;align-items:center'>Premium User &#x1F389</div>",loginBtnDiv.style.display="none"):alert("Invalid personal identifier")}).catch(e=>{console.error("There was a problem with the fetch operation:",e)})});const LASTSALESCOUNT=7,EARNINGSGOAL=10,DEBUG=!1;let rawSalesMatrix=[],IDX=1,goalDay=!1,goalMonth=!1,goalWeek=!1;function startup(){retrieveSales(getUrl(1,subtractDaysFromDate(getTodaysDate(),30),getTodaysDate())),chrome.storage.sync.set({lastPopDate:getTodaysDate()})}async function retrieveSales(e){fetch(e).then(e=>{if(200===e.status)return e.text();throw Error("Status != 200")}).then(e=>{let t=extractContent(e);rawSalesMatrix=rawSalesMatrix.concat(t);let a=[];for(let n=0;n<rawSalesMatrix.length;n++)a=a.concat(extractSales(rawSalesMatrix[n]));let r=getEarnings(a);updateTotals(r),chrome.storage.sync.set({earnings:r}),chrome.storage.local.set({popupSales:a})}).catch(e=>{console.log(e)})}function extractContent(e){let t=[];var a=new DOMParser().parseFromString(e,"text/html"),n=a.querySelectorAll(".odd, .even"),r=a.querySelectorAll(".counter")[0],l=parseInt(r.querySelectorAll("span")[0].innerText),s=parseInt(r.innerText.split("-")[1].split(" ")[0]);return t.push(n),s<l&&retrieveSales(getUrl(IDX+=1,subtractDaysFromDate(getTodaysDate(),30),getTodaysDate())),t}function extractSales(e){let t=[];for(let a=0;a<e.length;a++){let n={},r=e[a].querySelectorAll("td");n.date=r[0].innerHTML,n.orderId=r[1].innerHTML,n.source=r[2].innerHTML;let l=r[3].textContent;n.itemSold=l.substring(98,112).replace(/[]/g,"")+"...",n.buyer=r[4].innerHTML,n.lastDownload=r[5].innerHTML,n.licenses=r[6].innerHTML,n.price=r[7].innerHTML,n.commission=r[8].innerHTML,n.transactionFee=r[9].innerHTML,n.tax_seller=r[10].innerHTML,n.tax_tpt=r[11].innerHTML,n.earnings=r[12].innerText.replace(/[^.0-9$]/g,""),t.push(n)}return t}function updateSalesTable(e){let t=0;salesTable.innerHTML="",!function a(){var n=document.createElement("div");n.classList.add("row");for(let r=0;r<3;r++){var l=document.createElement("div");l.classList.add("col","themed-grid-col");let s=e[t],o=s.date,c=s.itemSold,g=s.earnings;0==r&&(l.innerHTML=o),1==r&&(l.innerHTML=c),2==r&&(l.innerHTML=g),n.appendChild(l)}salesTable.appendChild(n),++t<7&&setTimeout(a,20)}()}function getEarnings(e){let t=0,a=0,n=0,r=getTodaysDate(),l=r[0]+"/"+r[1]+"/"+r[2],s=subtractDaysFromDate(r,7),o=subtractDaysFromDate(r,30);for(let c=0;c<e.length;c++){let g=e[c],u=g.date,d=parseFloat(g.earnings.replace("$",""));u==l&&(t+=d),u>=s[0]+"/"+s[1]+"/"+s[2]&&(a+=d),u>=o[0]+"/"+o[1]+"/"+o[2]&&(n+=d)}return[t.toFixed(2),a.toFixed(2),n.toFixed(2)]}function updateTotals(e){let t=parseFloat(e[1].replace("$",""));weeklyEarnings.innerHTML="$"+t;let a=getPercentage(t,"week");var n=a[0],r=parseInt(a[1]).toString();let l,s;switch(n){case 0:s=!1,weeklyCircle.className="ecircle c100 p"+r+" small green";break;case 1:s=!0,weeklyCircle.className="ecircle c100 p"+r+" small orange",goalDay||(goal.className="orange",l=(n-1)*100+parseInt(r),goal.innerHTML="You beat your weekly goal by "+l+"% &#x1F389");break;default:s=!0,goalDay||(goal.className="pink",l=(n-1)*100+parseInt(r),goal.innerHTML="You beat your weekly goal by "+l+"%&#x1F37E"),weeklyCircle.className="ecircle c100 p"+r+" small pink"}let o=parseFloat(e[2].replace("$",""));monthlyEarnings.innerHTML="$"+o;var n=(a=getPercentage(o,"month"))[0],r=parseInt(a[1]).toString();switch(n){case 0:goalMonth=!1,monthlyCircle.className="ecircle c100 p"+r+" small green";break;case 1:goalDay||s||(goal.className="orange",l=(n-1)*100+parseInt(r),goal.innerHTML=" You beat your monthly goal by "+l+"% &#x1F389"),monthlyCircle.className="ecircle c100 p"+r+" small orange";break;default:goalMonth=!0,goalDay||s||(goal.className="pink",l=(n-1)*100+parseInt(r),goal.innerHTML="You beat your monthly goal by "+l+"%&#x1F37E"),monthlyCircle.className="ecircle c100 p"+r+" small pink"}let c=parseFloat(e[0].replace("$",""));todaysEarnings.innerHTML="$"+c;var n=(a=getPercentage(c))[0],r=parseInt(a[1]).toString();switch(n){case 0:todaysCircle.className="ecircle c100 p"+r+" small green";break;case 1:todaysCircle.className="ecircle c100 p"+r+" small orange",goal.className="orange",l=(n-1)*100+parseInt(r),goal.innerHTML="You beat your daily goal by "+l+"% &#x1F389";break;default:goal.className="pink",l=(n-1)*100+parseInt(r),goal.innerHTML="You beat your daily goal by "+l+"%&#x1F37E",todaysCircle.className="ecircle c100 p"+r+" small pink"}}function getPercentage(e,t){let a;switch(t){case"week":a=e/(10/30*7);break;case"month":a=e/10;break;default:a=e/(10/30)}return getDecimalPart(a)}function getDecimalPart(e){let t=[],a=parseInt(e);if(t.push(a),Number.isInteger(e))return t.push(0),t;let n=e.toString().split(".")[1];if(n.length>=2){let r=n.substring(0,2);return t.push(r),t}return 1===n.length&&t.push(n+"0"),t}function getHeader(){chrome.storage.sync.get(function(e){e.sellerName&&e.imgUrl?(nameInput.innerHTML=e.sellerName,imageInput.src=e.imgUrl):fetch("https://www.teacherspayteachers.com/Dashboard").then(e=>{if(200===e.status)return e.text();throw Error("Status != 200")}).then(e=>{var t=new DOMParser().parseFromString(e,"text/html");let a=t.getElementsByClassName("Image-module__image--PG7Ib").item(0).src,n=t.getElementsByClassName("SellerDashboardHeader__details")[0].querySelectorAll(".Link-module__link--GFbUH")[0].innerText;nameInput.innerHTML=n,imageInput.src=a,console.log(n,a),chrome.storage.sync.set({sellerName:n}),chrome.storage.sync.set({imgUrl:a})}).catch(e=>{console.log(e)})})}function getUrl(e,t,a){return"https://www.teacherspayteachers.com/My-Sales/page:"+e+"?source=Overall&start_date="+t[0]+"%2F"+t[1]+"%2F"+t[2]+"&end_date="+a[0]+"%2F"+a[1]+"%2F"+a[2]}function subtractDaysFromDate(e,t){let[a,n,r]=e,l=new Date(`${a}/${n}/${r}`);l.setDate(l.getDate()-t);let s=l.getMonth()+1,o=l.getDate(),c=l.getFullYear(),g=[String(s).padStart(2,"0"),String(o).padStart(2,"0"),String(c)];return g}function createTxt(e){var t=document.createElement("a");t.download="data.json";var a=new Blob([e],{type:"text/plain"});t.href=window.URL.createObjectURL(a),t.click()}function updateList(){let e=document.createElement("li");e.innerHTML=sales[i],popupList.appendChild(e)}function getTodaysDate(){var e=new Date,t=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),n=e.getFullYear();let r=[];return r.push(a),r.push(t),r.push(n),r}chrome.storage.sync.get(function(e){if(e.soundOn||(salesSwitch.checked=!1),getHeader(),!e.imgUrl||!e.sellerName){getHeader(),startup();return}if(null!=e.earnings){chrome.storage.local.get(function(e){updateSalesTable(e.popupSales)});updateTotals(e.earnings)}if(e.lastPopDate){let t=getTodaysDate(),a=e.lastPopDate;console.log(t,a),(t[0]!=a[0]||t[1]!=a[1]||t[2]!=a[2])&&startup()}e.hasChanges&&chrome.storage.sync.set({hasChanges:!1}),startup()}),chrome.runtime.sendMessage({id:"updateBadge"}),window.addEventListener("click",function(e){void 0!==e.target.href&&chrome.tabs.create({url:e.target.href})}),salesSwitch.addEventListener("click",function(){salesSwitch.checked?(chrome.runtime.sendMessage({id:"saleSound"}),chrome.storage.sync.set({soundOn:!0})):chrome.storage.sync.set({soundOn:!1})});